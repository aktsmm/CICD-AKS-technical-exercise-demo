{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": ""
      },
      "name": "text-header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "timerange-param",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "ğŸ“… æ™‚é–“ç¯„å›²",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000,
                  "createdTime": "2023-01-01T00:00:00.000Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 86400000,
                  "createdTime": "2023-01-01T00:00:00.000Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 604800000,
                  "createdTime": "2023-01-01T00:00:00.000Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 2592000000,
                  "createdTime": "2023-01-01T00:00:00.000Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "severity-param",
            "version": "KqlParameterItem/1.0",
            "name": "AlertSeverity",
            "label": "ğŸš¨ é‡å¤§åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼",
            "type": 2,
            "multiSelect": true,
            "quote": "\"",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[{\"value\":\"High\",\"label\":\"High\",\"selected\":true},{\"value\":\"Medium\",\"label\":\"Medium\",\"selected\":true},{\"value\":\"Low\",\"label\":\"Low\",\"selected\":true},{\"value\":\"Informational\",\"label\":\"Informational\",\"selected\":true}]",
            "value": ["High", "Medium", "Low", "Informational"]
          }
        ],
        "style": "above",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters-filters"
    },
    {
      "type": 1,
      "content": {
        "json": "### ğŸ“ˆ é‹ç”¨çŠ¶æ³ã®æ¦‚è¦\n\nãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åé›†ã•ã‚Œã¦ã„ã‚‹Azure Activity Logã‹ã‚‰ã€é‹ç”¨ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚"
      },
      "name": "text-overview"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let startTime = ago(30d);\r\nlet endTime = now();\r\n\r\nAzureActivity\r\n| where TimeGenerated between (startTime .. endTime)\r\n| extend CallerDisplay = coalesce(Caller, \"Unknown\")\r\n| extend Category = case(\r\n    CategoryValue == \"Administrative\", \"Management\",\r\n    CategoryValue == \"Security\", \"Security\",\r\n    CategoryValue == \"Policy\", \"Policy\",\r\n    CategoryValue == \"Recommendation\", \"Recommendation\",\r\n    CategoryValue == \"ServiceHealth\", \"ServiceHealth\",\r\n    \"Other\" // â† ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆæœ€å¾Œã«1ã¤ã ã‘ï¼‰\r\n  )\r\n| summarize OperationCount = count(),\r\n            ResourceCount = dcount(ResourceId),\r\n            LastOperationTime = max(TimeGenerated)\r\n  by Category, OperationNameValue, CallerDisplay, CallerIpAddress\r\n| order by OperationCount desc\r\n| take 20\r\n",
        "size": 0,
        "title": "ç›£æŸ»ãƒ­ã‚° (Administrative & Security)",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Count",
              "formatter": 8,
              "formatOptions": {
                "palette": "blue"
              }
            }
          ]
        }
      },
      "name": "query-activity-log"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let startTime = ago(7d);\r\nlet endTime = now();\r\n\r\n// AzureActivity å´ï¼šCaller GUIDã”ã¨ã®æ“ä½œé›†è¨ˆ\r\nlet Activity = AzureActivity\r\n| where TimeGenerated between (startTime .. endTime)\r\n| where isnotempty(Caller)\r\n| summarize TotalOps = count(), LastOperation = max(TimeGenerated) by Caller;\r\n\r\n// AuditLogs å´ï¼šã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¯¾å¿œã‚’æŠ½å‡º\r\nlet PrincipalNames = AuditLogs\r\n| extend AppId = tostring(InitiatedBy.app.id),\r\n         AppName = tostring(InitiatedBy.app.displayName),\r\n         UserId = tostring(InitiatedBy.user.id),\r\n         UserName = tostring(InitiatedBy.user.userPrincipalName)\r\n| project Caller = case(\r\n    isnotempty(AppId), AppId,\r\n    isnotempty(UserId), UserId,\r\n    \"Unknown\"\r\n  ),\r\n  DisplayName = case(\r\n    isnotempty(AppName), AppName,\r\n    isnotempty(UserName), UserName,\r\n    \"Unknown\"\r\n  )\r\n| distinct Caller, DisplayName;\r\n\r\n// çµåˆã—ã¦äººé–“ãŒèª­ã‚ã‚‹åå‰ã«å¤‰æ›\r\nActivity\r\n| join kind=leftouter (PrincipalNames) on Caller\r\n| extend CallerResolved = iif(DisplayName != \"Unknown\", DisplayName, Caller)\r\n| order by TotalOps desc\r\n| project  Caller, TotalOps, LastOperation\r\n| take 10\r\n\r\n",
        "size": 0,
        "title": "ãƒªã‚½ãƒ¼ã‚¹æ“ä½œæ•°ä¸Šä½ãƒ¦ãƒ¼ã‚¶ãƒ¼",
        "timeContext": {
          "durationMs": 604800000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Operations",
              "formatter": 8,
              "formatOptions": {
                "palette": "orange"
              }
            }
          ]
        },
        "sortBy": []
      },
      "name": "query-top-callers"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "AzureActivity\n| where TimeGenerated > ago(24h)\n| summarize Count = count() by bin(TimeGenerated, 1h), CategoryValue\n| order by TimeGenerated asc\n| render timechart",
        "size": 0,
        "title": "éå»24æ™‚é–“ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "timechart"
      },
      "name": "query-timeline"
    },
    {
      "type": 1,
      "content": {
        "json": "### Governance & Compliance\n\nPolicy ã®é©ç”¨çŠ¶æ³ã‚„æ“ä½œå¯†åº¦ã‚’ç¤ºã—ã€çµ±åˆ¶ã®å¥å…¨æ€§ã‚’ç¢ºèªã—ã¾ã™ã€‚"
      },
      "name": "text-governance"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "AzureActivity\n| where TimeGenerated > ago(7d)\n| where CategoryValue == \"Policy\"\n| summarize Count = count() by OperationNameValue, Resource\n| order by Count desc\n| take 10",
        "size": 0,
        "title": "éå»7æ—¥é–“ã® Azure Policy ã‚¤ãƒ™ãƒ³ãƒˆ",
        "timeContext": {
          "durationMs": 604800000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "barchart"
      },
      "name": "query-policy-events"
    },
    {
      "type": 1,
      "content": {
        "json": "### External Exposure Watch\n\nIP åˆ¶é™ãªã—ã§å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ã„ã‚‹æ§‹æˆã‚’æ£šå¸ã—ã—ã€å„ªå…ˆçš„ã«æ”¹å–„ã™ã¹ãå¯¾è±¡ã‚’æŠŠæ¡ã—ã¾ã™ã€‚"
      },
      "name": "text-external-access"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\n| where type in~ (\"microsoft.storage/storageaccounts\", \"microsoft.sql/servers\", \"microsoft.keyvault/vaults\", \"microsoft.containerregistry/registries\", \"microsoft.web/sites\", \"microsoft.dbforpostgresql/servers\")\n| extend PublicSetting = coalesce(tostring(properties.publicNetworkAccess), tostring(properties.networkAcls.defaultAction), tostring(properties.networkRuleSet.defaultAction))\n| where PublicSetting in~ (\"Enabled\", \"Allow\", \"AllNetworks\")\n| extend Endpoint = coalesce(tostring(properties.primaryEndpoints.web), tostring(properties.primaryEndpoints.blob), tostring(properties.fullyQualifiedDomainName), tostring(properties.loginServer))\n| project SubscriptionId = subscriptionId, ResourceGroup = resourceGroup, ResourceName = name, ResourceType = type, PublicSetting, Endpoint\n| order by ResourceType asc, ResourceName asc",
        "size": 0,
        "title": "å¤–éƒ¨å…¬é–‹ãŒæœ‰åŠ¹ãª PaaS ãƒªã‚½ãƒ¼ã‚¹",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "visualization": "table"
      },
      "name": "query-public-paas"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "union isfuzzy=true\n(SecurityIncident\n| where TimeGenerated > ago(7d)\n| extend OwnerName = coalesce(Owner.objectName, \"Unassigned\")\n| summarize IncidentCount = count(), OpenCount = countif(IncidentStatus != \"Closed\"), LatestUpdate = max(TimeGenerated) by Severity, OwnerName\n| extend SeverityOrder = case(Severity == \"High\", 0, Severity == \"Medium\", 1, Severity == \"Low\", 2, 3)\n| order by SeverityOrder asc, OpenCount desc, IncidentCount desc\n| project-away SeverityOrder\n| take 50),\n(print Message = \"â³ Defender for Cloud ãƒ‡ãƒ¼ã‚¿åé›†ä¸­... Workspaceã«æ¥ç¶šå¾Œã€24-48æ™‚é–“ã§ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™\")",
        "size": 0,
        "title": "é‡å¤§ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ‹…å½“çŠ¶æ³ (éå»7æ—¥)",
        "timeContext": {
          "durationMs": 604800000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "OpenCount",
              "formatter": 8,
              "formatOptions": {
                "palette": "red"
              }
            }
          ]
        }
      },
      "name": "query-incidents"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let FailedOps = AzureActivity\n| where TimeGenerated > ago(3d)\n| where ActivityStatusValue == \"Failed\"\n| where OperationNameValue has_any (\"Delete\", \"Write\", \"Policy\", \"RoleAssignment\", \"Security\", \"Administration\")\n| extend CallerDisplay = coalesce(Caller, CallerIpAddress, \"Unknown\")\n| summarize Failures = count(), LatestFailure = max(TimeGenerated), AffectedResources = dcount(ResourceId) by CallerDisplay, OperationNameValue, ResourceGroup\n| order by Failures desc, LatestFailure desc\n| take 20;\nlet HasData = toscalar(FailedOps | count) > 0;\nFailedOps\n| union (print Message = \"âœ… éå»3æ—¥é–“ã«é‡è¦ãªå¤±æ•—æ“ä½œã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆæ­£å¸¸çŠ¶æ…‹ï¼‰\", CallerDisplay = \"\", OperationNameValue = \"\", ResourceGroup = \"\", Failures = 0, LatestFailure = datetime(null), AffectedResources = 0 | where not(HasData))\n| project-away Message",
        "size": 0,
        "title": "é‡è¦æ“ä½œã®å¤±æ•—ã‚¤ãƒ™ãƒ³ãƒˆ (éå»3æ—¥)",
        "timeContext": {
          "durationMs": 259200000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Failures",
              "formatter": 8,
              "formatOptions": {
                "palette": "red"
              }
            }
          ]
        }
      },
      "name": "query-failed-critical"
    },
    {
      "type": 1,
      "content": {
        "json": "### ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"
      },
      "name": "text-network-security"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Resources\n| where type =~ \"microsoft.network/networksecuritygroups\"\n| extend securityRules = properties.securityRules\n| mv-expand securityRules\n| extend access = tostring(securityRules.properties.access)\n| extend direction = tostring(securityRules.properties.direction)\n| extend sourcePrefix = tostring(securityRules.properties.sourceAddressPrefix)\n| where access == \"Allow\" and direction == \"Inbound\"\n| where sourcePrefix in (\"*\", \"0.0.0.0/0\", \"Internet\", \"<nw>/0\")\n| extend Priority = toint(securityRules.properties.priority)\n| project SubscriptionId = subscriptionId, ResourceGroup = resourceGroup, NsgName = name, RuleName = tostring(securityRules.name), Priority, DestinationPort = tostring(securityRules.properties.destinationPortRange), Protocol = tostring(securityRules.properties.protocol), SourcePrefix = sourcePrefix\n| order by Priority asc nulls last, NsgName asc",
        "size": 0,
        "title": "å¤–éƒ¨è¨±å¯ NSG ãƒ«ãƒ¼ãƒ« (æœ€æ–°çŠ¶æ…‹)",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "visualization": "table"
      },
      "name": "query-open-nsg-rules"
    },
    {
      "type": 1,
      "content": {
        "json": "### ğŸ›¡ï¸ Microsoft Defender for Cloud\n\nãƒªã‚¹ã‚¯ã®é›†ä¸­ç®‡æ‰€ã¨æ¨å¥¨äº‹é …ã‚’ã¾ã¨ã‚ã€æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æç¤ºã—ã¾ã™ã€‚"
      },
      "name": "text-defender"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let startTime = todatetime(\"{TimeRange:start}\");\nlet endTime = todatetime(\"{TimeRange:end}\");\nlet severityList = \"High,Medium,Low,Informational\";  // â† é…åˆ—ã‚’æ–‡å­—åˆ—ã§ä¿æŒ\nlet severities = split(severityList, \",\");            // â† KQLã§é…åˆ—ã«å¤‰æ›\nlet AlertData = SecurityAlert\n| where TimeGenerated between (startTime .. endTime)\n| where set_has_element(severities, AlertSeverity)\n| summarize AlertCount = count(), LatestAlert = max(TimeGenerated)\n    by AlertName, AlertSeverity, ProviderName\n| order by AlertCount desc, LatestAlert desc;\nlet HasData = toscalar(AlertData | count) > 0;\nAlertData\n| union (\n    print Message = \"â„¹ï¸ é¸æŠã—ãŸæ¡ä»¶ã§ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚Defender Continuous ExportãŒæœ‰åŠ¹ãªå ´åˆã€ãƒ‡ãƒ¼ã‚¿åæ˜ ã«æœ€å¤§24æ™‚é–“ã‹ã‹ã‚Šã¾ã™\",\n          AlertName = \"\",\n          AlertSeverity = \"\",\n          ProviderName = \"\",\n          AlertCount = 0,\n          LatestAlert = datetime(null)\n    | where not(HasData)\n)\n| project-away Message\n",
        "size": 0,
        "title": "Defender ã‚¢ãƒ©ãƒ¼ãƒˆ (ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨æ¸ˆ)",
        "timeContext": {
          "durationMs": 604800000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "AlertSeverity",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "High",
                    "representation": "critical",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "Medium",
                    "representation": "warning",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "info",
                    "text": "{0}{1}"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "query-defender-alerts"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let startTime = todatetime(\"{TimeRange:start}\");\nlet endTime   = todatetime(\"{TimeRange:end}\");\nlet severityText = trim(' ', tostring({AlertSeverity}));\nlet defaultSeverities = dynamic([\"High\", \"Medium\", \"Low\", \"Informational\"]);\nlet severities =\n    iif(severityText == \"\" or severityText == \"[]\",\n        defaultSeverities,\n        iif(severityText startswith \"[\",\n            parse_json(severityText),\n            parse_json(strcat(\"[\", severityText, \"]\"))\n        )\n    );\n\nlet DensityData =\n    SecurityAlert\n    | where TimeGenerated between (startTime .. endTime)\n    | where AlertSeverity in~ (severities)\n    | extend ResourceGroup = tostring(split(ResourceId, \"/\")[4])\n    | where isnotempty(ResourceGroup)\n    | summarize\n        Alerts        = count(),\n        HighSeverity  = countif(AlertSeverity == \"High\"),\n        MediumSeverity= countif(AlertSeverity == \"Medium\"),\n        LowSeverity   = countif(AlertSeverity == \"Low\"),\n        InfoSeverity  = countif(AlertSeverity == \"Informational\")\n      by ResourceGroup\n    | order by Alerts desc\n    | take 10;\n\nlet HasData = toscalar(DensityData | count) > 0;\nDensityData\n| union (\n    print ResourceGroup = \"\", Alerts = 0, HighSeverity = 0, MediumSeverity = 0,\n          LowSeverity = 0, InfoSeverity = 0,\n          Message = \"â„¹ï¸ é¸æŠã—ãŸæ¡ä»¶ã§ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“\"\n    | where not(HasData)\n)\n| project-away Message",
        "size": 0,
        "title": "Defender ã‚¢ãƒ©ãƒ¼ãƒˆå¯†åº¦ (ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥)",
        "timeContext": {
          "durationMs": 604800000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "HighSeverity",
              "formatter": 8,
              "formatOptions": {
                "palette": "red"
              }
            }
          ]
        }
      },
      "name": "query-defender-density"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "SecurityResources\n| where type == \"microsoft.security/assessments\"\n| extend RecommendationSeverity = tostring(properties.metadata.severity)\n| summarize Count = count() by RecommendationSeverity\n| order by Count desc",
        "size": 0,
        "title": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¨å¥¨äº‹é … (é‡è¦åº¦åˆ¥)",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "visualization": "piechart"
      },
      "name": "query-recommendations"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/af0f28a5-faa0-4397-b1ab-ca2006a28e0c/resourcegroups/odl-candidate-sandbox-02-1948069/providers/microsoft.operationalinsights/workspaces/log-dev"
  ],
  "fromTemplateId": "sentinel-UserWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
