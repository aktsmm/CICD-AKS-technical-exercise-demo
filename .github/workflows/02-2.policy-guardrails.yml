name: 2-2. Deploy Azure Policy Guardrails

on:
    workflow_run:
        workflows:
            - "1. Deploy Infrastructure"
        types:
            - completed
    workflow_dispatch:
    push:
        branches:
            - main
        paths:
            - ".github/workflows/02-2.policy-guardrails.yml"

permissions:
    contents: read
    security-events: write

env:
    AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    AZURE_LOCATION_VAR: ${{ vars.AZURE_LOCATION }}
    AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
    LOCATION: ${{ vars.AZURE_LOCATION }}

jobs:
    scan-iac:
        name: Scan Guardrail Bicep for Security Issues
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Run Checkov Scan
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: infra/
                  framework: bicep
                  output_format: sarif
                  output_file_path: checkov-results.sarif
                  soft_fail: true

            - name: Upload Checkov Results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              continue-on-error: true
              with:
                  sarif_file: checkov-results.sarif

    deploy-guardrails:
        name: Deploy Policy Guardrails
        runs-on: ubuntu-latest
        needs: scan-iac
        if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Build Custom MCSB Definition
              shell: pwsh
              run: |
                  ./Scripts/Build-CustomMcsb.ps1 -OutputPath ./infra/policies/mcsb-v2-pruned.json

            - name: Azure Login
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Resolve Deployment Location
              shell: bash
              run: |
                  location="${AZURE_LOCATION_VAR}"

                  if [ -z "$location" ] && [ -n "${AZURE_RESOURCE_GROUP}" ]; then
                      echo "ðŸ” Repository variable AZURE_LOCATION ãŒæœªè¨­å®šã®ãŸã‚ã€ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ— ${AZURE_RESOURCE_GROUP} ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚"
                      location=$(az group show --name "${AZURE_RESOURCE_GROUP}" --query location -o tsv 2>/dev/null || true)
                  fi

                  if [ -z "$location" ]; then
                      echo "::error::ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚GitHub Variables ã§ AZURE_LOCATION ã‚’è¨­å®šã™ã‚‹ã‹ã€ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®å ´æ‰€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"
                      exit 1
                  fi

                  echo "âœ… Azure Policy ã‚’å±•é–‹ã™ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: $location"
                  echo "LOCATION=$location" >> "$GITHUB_ENV"

            - name: Verify Required RBAC Permissions
              id: check_permissions
              shell: bash
              run: |
                  echo "Checking if Service Principal has 'Resource Policy Contributor' role..."
                  SP_OBJECT_ID=$(az ad sp list --filter "appId eq '$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientId)'" --query '[0].id' -o tsv)

                  echo "SP_OBJECT_ID=$SP_OBJECT_ID" >> $GITHUB_OUTPUT

                  ROLE_ASSIGNED=$(az role assignment list \
                    --assignee-object-id "$SP_OBJECT_ID" \
                    --role "Resource Policy Contributor" \
                    --scope "/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}" \
                    --query '[].roleDefinitionName' -o tsv)

                  if [ -z "$ROLE_ASSIGNED" ]; then
                    echo "âŒ WARNING: Service Principal lacks 'Resource Policy Contributor' role!"
                    echo "has_permission=false" >> $GITHUB_OUTPUT
                    
                    echo "::warning::Service Principal (Object ID: $SP_OBJECT_ID) lacks 'Resource Policy Contributor' role."
                    echo "::warning::Attempting automatic role assignment..."
                    
                    # Try to assign role (may fail if current context lacks User Access Administrator)
                    if az role assignment create \
                      --assignee-object-id "$SP_OBJECT_ID" \
                      --assignee-principal-type ServicePrincipal \
                      --role "Resource Policy Contributor" \
                      --scope "/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}" 2>/dev/null; then
                      echo "âœ… Successfully assigned 'Resource Policy Contributor' role"
                      echo "has_permission=true" >> $GITHUB_OUTPUT
                    else
                      echo "::error::Failed to auto-assign role. Run this command locally:"
                      echo "::error::  az role assignment create \\"
                      echo "::error::    --assignee-object-id $SP_OBJECT_ID \\"
                      echo "::error::    --assignee-principal-type ServicePrincipal \\"
                      echo "::error::    --role 'Resource Policy Contributor' \\"
                      echo "::error::    --scope '/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}'"
                      echo "has_permission=false" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "âœ… Service Principal has required permissions"
                    echo "has_permission=true" >> $GITHUB_OUTPUT
                  fi

            - name: Wait for RBAC propagation
              if: steps.check_permissions.outputs.has_permission == 'true'
              run: |
                  echo "Waiting 30 seconds for RBAC changes to propagate..."
                  sleep 30

            - name: Publish Custom MCSB Policy Set
              shell: pwsh
              run: |
                  $definitionPath = Join-Path $PWD 'infra/policies/mcsb-v2-pruned.json'
                  $policySet = Get-Content -Path $definitionPath -Raw | ConvertFrom-Json -Depth 100

                  $tempDir = Join-Path $env:RUNNER_TEMP ([guid]::NewGuid().ToString())
                  New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

                  function Export-JsonSection {
                      param(
                          [Parameter(Mandatory = $true)][object]$Data,
                          [Parameter(Mandatory = $true)][string]$FileName
                      )

                      $targetPath = Join-Path $tempDir $FileName
                      $Data | ConvertTo-Json -Depth 100 | Set-Content -Path $targetPath -Encoding utf8
                      return $targetPath
                  }

                  $definitionsFile = Export-JsonSection -Data $policySet.properties.policyDefinitions -FileName 'definitions.json'

                  if ($policySet.properties.PSObject.Properties.Name -contains 'version') {
                      # Remove unsupported version field because policy set definitions currently allow only a single version.
                      $policySet.properties.PSObject.Properties.Remove('version') | Out-Null
                  }

                  $cliArgs = @(
                      '--name', 'Custom-MCSB-Core',
                      '--subscription', $env:AZURE_SUBSCRIPTION_ID,
                      '--display-name', $policySet.properties.displayName,
                      '--description', $policySet.properties.description,
                      '--definitions', "@$definitionsFile"
                  )
                  if ($policySet.properties.parameters) {
                      $parametersFile = Export-JsonSection -Data $policySet.properties.parameters -FileName 'parameters.json'
                      $cliArgs += @('--params', "@$parametersFile")
                  }

                  if ($policySet.properties.metadata) {
                      $metadataFile = Export-JsonSection -Data $policySet.properties.metadata -FileName 'metadata.json'
                      $cliArgs += @('--metadata', "@$metadataFile")
                  }

                  if ($policySet.properties.policyDefinitionGroups) {
                      $groupsFile = Export-JsonSection -Data $policySet.properties.policyDefinitionGroups -FileName 'definition-groups.json'
                      $cliArgs += @('--definition-groups', "@$groupsFile")
                  }

                  # Retry logic for RBAC propagation delays
                  $maxAttempts = 3
                  $attempt = 1
                  $success = $false

                  while ($attempt -le $maxAttempts -and -not $success) {
                      Write-Host "Attempt $attempt of ${maxAttempts}: Publishing custom MCSB policy set..."
                      
                      $createResult = az policy set-definition create @cliArgs 2>&1
                      if ($LASTEXITCODE -eq 0) {
                          Write-Host "âœ… Policy set definition created successfully"
                          $success = $true
                      } elseif ($createResult -match 'AuthorizationFailed') {
                          if ($attempt -lt $maxAttempts) {
                              Write-Host "âš ï¸ Authorization failed (RBAC may still be propagating). Waiting 30 seconds before retry..."
                              Start-Sleep -Seconds 30
                              $attempt++
                          } else {
                              Write-Host "Create failed; attempting to update existing definition."
                              $updateResult = az policy set-definition update @cliArgs 2>&1
                              if ($LASTEXITCODE -eq 0) {
                                  Write-Host "âœ… Policy set definition updated successfully"
                                  $success = $true
                              } else {
                                  Write-Host "::error::Failed to publish custom MCSB policy set."
                                  Write-Host "::error::Error details: $updateResult"
                                  Write-Host "::error::Ensure Service Principal has 'Resource Policy Contributor' role assigned."
                                  throw 'Failed to publish custom MCSB policy set. Check workflow logs for details.'
                              }
                          }
                      } else {
                          Write-Host "Create failed; attempting to update existing definition."
                          $updateResult = az policy set-definition update @cliArgs 2>&1
                          if ($LASTEXITCODE -eq 0) {
                              Write-Host "âœ… Policy set definition updated successfully"
                              $success = $true
                          } else {
                              throw 'Failed to publish custom MCSB policy set.'
                          }
                      }
                  }

            - name: Deploy Guardrail Bicep
              uses: azure/arm-deploy@v1
              with:
                  subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
                  scope: subscription
                  region: ${{ env.LOCATION }}
                  template: ./infra/policy-guardrails.bicep
                  parameters: >
                      managedIdentityLocation=${{ env.LOCATION }}
                      @infra/parameters/policy-dev.parameters.json
                  deploymentName: policy-guardrails-${{ env.LOCATION }}-${{ github.run_number }}
                  failOnStdErr: false
