name: 2-2. Deploy Azure Policy Guardrails

on:
    workflow_run:
        workflows:
            - "1. Deploy Infrastructure"
        types:
            - completed
    workflow_dispatch:
    push:
        branches:
            - main
        paths:
            - ".github/workflows/02-2.policy-guardrails.yml"

permissions:
    contents: read
    security-events: write

env:
    AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
    AZURE_LOCATION_VAR: ${{ vars.AZURE_LOCATION }}
    AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
    LOCATION: ${{ vars.AZURE_LOCATION }}

jobs:
    scan-iac:
        name: Scan Guardrail Bicep for Security Issues
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Run Checkov Scan
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: infra/
                  framework: bicep
                  output_format: sarif
                  output_file_path: checkov-results.sarif
                  soft_fail: true

            - name: Upload Checkov Results
              uses: github/codeql-action/upload-sarif@v4
              if: always()
              continue-on-error: true
              with:
                  sarif_file: checkov-results.sarif

    deploy-guardrails:
        name: Deploy Policy Guardrails
        runs-on: ubuntu-latest
        needs: scan-iac
        if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Build Custom MCSB Definition
              shell: pwsh
              run: |
                  ./Scripts/Build-CustomMcsb.ps1 -OutputPath ./infra/policies/mcsb-v2-pruned.json

            - name: Azure Login
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Resolve Deployment Location
              shell: bash
              run: |
                  SUBSCRIPTION_ID="${AZURE_SUBSCRIPTION_ID:-${{ vars.AZURE_SUBSCRIPTION_ID }}}"

                  if [ -z "$SUBSCRIPTION_ID" ]; then
                      echo "::error::AZURE_SUBSCRIPTION_ID „ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇGitHub Variables „ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                      exit 1
                  fi

                  location="${AZURE_LOCATION_VAR}"

                  if [ -z "$location" ] && [ -n "${AZURE_RESOURCE_GROUP}" ]; then
                      echo "üîç Repository variable AZURE_LOCATION „ÅåÊú™Ë®≠ÂÆö„ÅÆ„Åü„ÇÅ„ÄÅ„É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó ${AZURE_RESOURCE_GROUP} „ÅÆ„É™„Éº„Ç∏„Éß„É≥„ÇíÂèñÂæó„Åó„Åæ„Åô„ÄÇ"
                      location=$(az group show --name "${AZURE_RESOURCE_GROUP}" --query location -o tsv 2>/dev/null || true)
                  fi

                  # Êó¢Â≠ò„ÅÆ„Éù„É™„Ç∑„ÉºÂâ≤„ÇäÂΩì„Å¶„ÅÆ location „ÇíÂèÇÁÖß„Åó„ÄÅ„É™„Éº„Ç∏„Éß„É≥„ÇíÂõ∫ÂÆö„Åô„Çã
                  env_file="infra/parameters/policy-dev.parameters.json"
                  deploy_env=""
                  if [ -f "$env_file" ]; then
                      deploy_env=$(jq -r '.parameters.environment.value // empty' "$env_file" 2>/dev/null)
                  fi
                  if [ -z "$deploy_env" ]; then
                      deploy_env="dev"
                  fi

                  assignments=(
                    "asgmt-cis140-${deploy_env}"
                    "asgmt-mcsb-${deploy_env}"
                    "asgmt-storage-public-${deploy_env}"
                  )

                  for assignment in "${assignments[@]}"; do
                      existing_location=$(az policy assignment show \
                        --name "$assignment" \
                        --scope "/subscriptions/${SUBSCRIPTION_ID}" \
                        --query location -o tsv 2>/dev/null || true)

                      if [ -n "$existing_location" ]; then
                          if [ -n "$location" ] && [ "$location" != "$existing_location" ]; then
                              echo "‚ö†Ô∏è Êó¢Â≠ò„ÅÆ„Éù„É™„Ç∑„ÉºÂâ≤„ÇäÂΩì„Å¶ $assignment „Åå $existing_location „Å´Â≠òÂú®„Åô„Çã„Åü„ÇÅ„ÄÅAZURE_LOCATION „Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÄÇ"
                          fi
                          location="$existing_location"
                          break
                      fi
                  done

                  if [ -z "$location" ]; then
                      echo "::error::„Éá„Éó„É≠„Ç§ÂÖà„É™„Éº„Ç∏„Éß„É≥„ÇíÁâπÂÆö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇGitHub Variables „Åß AZURE_LOCATION „ÇíË®≠ÂÆö„Åô„Çã„Åã„ÄÅ„É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó„ÅÆÂ†¥ÊâÄ„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                      exit 1
                  fi

                  echo "‚úÖ Azure Policy „ÇíÂ±ïÈñã„Åô„Çã„É™„Éº„Ç∏„Éß„É≥: $location"
                  echo "LOCATION=$location" >> "$GITHUB_ENV"
                  echo "AZURE_SUBSCRIPTION_ID=$SUBSCRIPTION_ID" >> "$GITHUB_ENV"

            - name: Verify Required RBAC Permissions
              id: check_permissions
              shell: bash
              run: |
                  SUBSCRIPTION_ID="${AZURE_SUBSCRIPTION_ID:-${{ vars.AZURE_SUBSCRIPTION_ID }}}"
                  if [ -z "$SUBSCRIPTION_ID" ]; then
                      echo "::error::AZURE_SUBSCRIPTION_ID „ÅåËß£Ê±∫„Åß„Åç„Åæ„Åõ„Çì„ÄÇGitHub Variables „ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                      exit 1
                  fi

                  CLIENT_ID=$(jq -r '.clientId // empty' <<< '${{ secrets.AZURE_CREDENTIALS }}')
                  if [ -z "$CLIENT_ID" ]; then
                      echo "::error::„Çµ„Éº„Éì„Çπ„Éó„É™„É≥„Ç∑„Éë„É´„ÅÆ clientId „Çí„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„Åã„ÇâÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇJSON ÂΩ¢Âºè„Å®„Ç≠„ÉºÂêç„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                      exit 1
                  fi

                  echo "Checking if Service Principal has 'Resource Policy Contributor' role..."
                  SP_OBJECT_ID=$(az ad sp list --filter "appId eq '${CLIENT_ID}'" --query '[0].id' -o tsv)

                  echo "SP_OBJECT_ID=$SP_OBJECT_ID" >> $GITHUB_OUTPUT

                  ROLE_ASSIGNED=$(az role assignment list \
                    --assignee-object-id "$SP_OBJECT_ID" \
                    --role "Resource Policy Contributor" \
                    --scope "/subscriptions/${SUBSCRIPTION_ID}" \
                    --query '[].roleDefinitionName' -o tsv)

                  if [ -z "$ROLE_ASSIGNED" ]; then
                    echo "‚ùå WARNING: Service Principal lacks 'Resource Policy Contributor' role!"
                    echo "has_permission=false" >> $GITHUB_OUTPUT
                    
                    echo "::warning::Service Principal (Object ID: $SP_OBJECT_ID) lacks 'Resource Policy Contributor' role."
                    echo "::warning::Attempting automatic role assignment..."
                    
                    # Try to assign role (may fail if current context lacks User Access Administrator)
                    if az role assignment create \
                      --assignee-object-id "$SP_OBJECT_ID" \
                      --assignee-principal-type ServicePrincipal \
                      --role "Resource Policy Contributor" \
                      --scope "/subscriptions/${SUBSCRIPTION_ID}" 2>/dev/null; then
                      echo "‚úÖ Successfully assigned 'Resource Policy Contributor' role"
                      echo "has_permission=true" >> $GITHUB_OUTPUT
                    else
                      echo "::error::Failed to auto-assign role. Run this command locally:"
                      echo "::error::  az role assignment create \\"
                      echo "::error::    --assignee-object-id $SP_OBJECT_ID \\"
                      echo "::error::    --assignee-principal-type ServicePrincipal \\"
                      echo "::error::    --role 'Resource Policy Contributor' \\"
                      echo "::error::    --scope '/subscriptions/${SUBSCRIPTION_ID}'"
                      echo "has_permission=false" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "‚úÖ Service Principal has required permissions"
                    echo "has_permission=true" >> $GITHUB_OUTPUT
                  fi

            - name: Wait for RBAC propagation
              if: steps.check_permissions.outputs.has_permission == 'true'
              run: |
                  echo "Waiting 30 seconds for RBAC changes to propagate..."
                  sleep 30

            - name: Publish Custom MCSB Policy Set
              shell: pwsh
              run: |
                  $definitionPath = Join-Path $PWD 'infra/policies/mcsb-v2-pruned.json'
                  $policySet = Get-Content -Path $definitionPath -Raw | ConvertFrom-Json -Depth 100

                  $tempDir = Join-Path $env:RUNNER_TEMP ([guid]::NewGuid().ToString())
                  New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

                  function Export-JsonSection {
                      param(
                          [Parameter(Mandatory = $true)][object]$Data,
                          [Parameter(Mandatory = $true)][string]$FileName
                      )

                      $targetPath = Join-Path $tempDir $FileName
                      $Data | ConvertTo-Json -Depth 100 | Set-Content -Path $targetPath -Encoding utf8
                      return $targetPath
                  }

                  $definitionsFile = Export-JsonSection -Data $policySet.properties.policyDefinitions -FileName 'definitions.json'

                  if ($policySet.properties.PSObject.Properties.Name -contains 'version') {
                      # Remove unsupported version field because policy set definitions currently allow only a single version.
                      $policySet.properties.PSObject.Properties.Remove('version') | Out-Null
                  }

                  $cliArgs = @(
                      '--name', 'Custom-MCSB-Core',
                      '--subscription', $env:AZURE_SUBSCRIPTION_ID,
                      '--display-name', $policySet.properties.displayName,
                      '--description', $policySet.properties.description,
                      '--definitions', "@$definitionsFile"
                  )
                  if ($policySet.properties.parameters) {
                      $parametersFile = Export-JsonSection -Data $policySet.properties.parameters -FileName 'parameters.json'
                      $cliArgs += @('--params', "@$parametersFile")
                  }

                  if ($policySet.properties.metadata) {
                      $metadataFile = Export-JsonSection -Data $policySet.properties.metadata -FileName 'metadata.json'
                      $cliArgs += @('--metadata', "@$metadataFile")
                  }

                  if ($policySet.properties.policyDefinitionGroups) {
                      $groupsFile = Export-JsonSection -Data $policySet.properties.policyDefinitionGroups -FileName 'definition-groups.json'
                      $cliArgs += @('--definition-groups', "@$groupsFile")
                  }

                  # Retry logic for RBAC propagation delays
                  $maxAttempts = 3
                  $attempt = 1
                  $success = $false

                  while ($attempt -le $maxAttempts -and -not $success) {
                      Write-Host "Attempt $attempt of ${maxAttempts}: Publishing custom MCSB policy set..."
                      
                      $createResult = az policy set-definition create @cliArgs 2>&1
                      if ($LASTEXITCODE -eq 0) {
                          Write-Host "‚úÖ Policy set definition created successfully"
                          $success = $true
                      } elseif ($createResult -match 'AuthorizationFailed') {
                          if ($attempt -lt $maxAttempts) {
                              Write-Host "‚ö†Ô∏è Authorization failed (RBAC may still be propagating). Waiting 30 seconds before retry..."
                              Start-Sleep -Seconds 30
                              $attempt++
                          } else {
                              Write-Host "Create failed; attempting to update existing definition."
                              $updateResult = az policy set-definition update @cliArgs 2>&1
                              if ($LASTEXITCODE -eq 0) {
                                  Write-Host "‚úÖ Policy set definition updated successfully"
                                  $success = $true
                              } else {
                                  Write-Host "::error::Failed to publish custom MCSB policy set."
                                  Write-Host "::error::Error details: $updateResult"
                                  Write-Host "::error::Ensure Service Principal has 'Resource Policy Contributor' role assigned."
                                  throw 'Failed to publish custom MCSB policy set. Check workflow logs for details.'
                              }
                          }
                      } else {
                          Write-Host "Create failed; attempting to update existing definition."
                          $updateResult = az policy set-definition update @cliArgs 2>&1
                          if ($LASTEXITCODE -eq 0) {
                              Write-Host "‚úÖ Policy set definition updated successfully"
                              $success = $true
                          } else {
                              throw 'Failed to publish custom MCSB policy set.'
                          }
                      }
                  }

            - name: Deploy Guardrail Bicep
              uses: azure/arm-deploy@v1
              with:
                  subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
                  scope: subscription
                  region: ${{ env.LOCATION }}
                  template: ./infra/policy-guardrails.bicep
                  parameters: >
                      managedIdentityLocation=${{ env.LOCATION }}
                      @infra/parameters/policy-dev.parameters.json
                  deploymentName: policy-guardrails-${{ github.run_number }}-${{ env.LOCATION }}
                  failOnStdErr: false
