name: 1. Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - "infra/**"
      - ".github/workflows/01.infra-deploy.yml"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_LOCATION_VAR: ${{ vars.AZURE_LOCATION }}
  LOCATION: ${{ vars.AZURE_LOCATION }}
  GRANT_OWNER_PARAMETER: ${{ vars.AZURE_GRANT_GITHUB_OWNER || 'false' }}

jobs:
  scan-iac:
    name: Scan IaC for Security Issues
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Checkov Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infra/
          framework: bicep
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true
        continue-on-error: true # âœ… çµ±ä¸€: ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã§ã‚‚ã‚¸ãƒ§ãƒ–ç¶šè¡Œ

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: checkov-results.sarif

      - name: Run Trivy Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          format: sarif
          output: trivy-config.sarif
          input: infra
          severity: CRITICAL,HIGH
          exit-code: 0
        continue-on-error: true # âœ… çµ±ä¸€: ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã§ã‚‚ã‚¸ãƒ§ãƒ–ç¶šè¡Œ

      - name: Upload Trivy Config Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: trivy-config.sarif

  deploy-infra:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    needs: scan-iac
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login (bootstrap RBAC)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve Deployment Location (bootstrap context)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        shell: bash
        run: |
          set -euo pipefail

          location="${AZURE_LOCATION_VAR}"

          if [ -z "$location" ] && [ -n "${RESOURCE_GROUP}" ]; then
            echo "ðŸ” Repository variable AZURE_LOCATION ãŒæœªè¨­å®šã®ãŸã‚ã€ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ— ${RESOURCE_GROUP} ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚"
            az account set --subscription "${AZURE_SUBSCRIPTION_ID}"
            location=$(az group show --name "${RESOURCE_GROUP}" --query location -o tsv 2>/dev/null || true)
          fi

          if [ -z "$location" ]; then
            echo "::error::ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚GitHub Variables ã§ AZURE_LOCATION ã‚’è¨­å®šã™ã‚‹ã‹ã€æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

          echo "âœ… ã‚¤ãƒ³ãƒ•ãƒ©ã‚’å±•é–‹ã™ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: $location"
          echo "LOCATION=$location" >> "$GITHUB_ENV"

      - name: Ensure Resource Group Exists (bootstrap phase)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        env:
          SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          LOCATION: ${{ env.LOCATION }}
        run: |
          set -euo pipefail

          az account set --subscription "$SUBSCRIPTION_ID"

          if az group exists --name "$RESOURCE_GROUP" | grep -iq true; then
            echo "Resource group '$RESOURCE_GROUP' already exists."
          else
            echo "Creating resource group '$RESOURCE_GROUP' in '$LOCATION'."
            az group create --name "$RESOURCE_GROUP" --location "$LOCATION"
          fi

      - name: Ensure RBAC for GitHub Actions Principal
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        env:
          PRINCIPAL_ID: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID }}
          SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          GRANT_OWNER: ${{ vars.AZURE_GRANT_GITHUB_OWNER || 'false' }}
        run: |
          set -euo pipefail

          az account set --subscription "$SUBSCRIPTION_ID"

          ensure_assignment() {
            local scope="$1"
            local roleName="$2"

            local existing
            existing=$(az role assignment list --assignee-object-id "$PRINCIPAL_ID" --role "$roleName" --scope "$scope" --query "[].id" -o tsv)

            if [[ -n "$existing" ]]; then
              echo "Role '$roleName' already present at scope '$scope'."
            else
              echo "Assigning role '$roleName' at scope '$scope'."
              az role assignment create \
                --assignee-object-id "$PRINCIPAL_ID" \
                --assignee-principal-type ServicePrincipal \
                --role "$roleName" \
                --scope "$scope"
            fi
          }

          RG_SCOPE="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}"

          ensure_assignment "$RG_SCOPE" "User Access Administrator"

          OWNER_SCOPE="/subscriptions/${SUBSCRIPTION_ID}"
          OWNER_ASSIGNMENTS=$(az role assignment list --assignee-object-id "$PRINCIPAL_ID" --role "Owner" --scope "$OWNER_SCOPE" --query "[].id" -o tsv)

          OWNER_PARAMETER="false"

          if [ "$GRANT_OWNER" = "true" ]; then
            if [[ -n "$OWNER_ASSIGNMENTS" ]]; then
              echo "Owner role already present; Bicep module will be skipped."
            else
              echo "Owner role not detected; Bicep module will assign." # avoid double assignment errors later
              OWNER_PARAMETER="true"
            fi
          else
            if [[ -n "$OWNER_ASSIGNMENTS" ]]; then
              echo "Owner role already assigned but automation flag is false; leaving as-is."
            fi
          fi

          echo "GRANT_OWNER_PARAMETER=$OWNER_PARAMETER" >> "$GITHUB_ENV"

      - name: Azure Logout (bootstrap context)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        run: az account clear

      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve Deployment Location
        shell: bash
        run: |
          set -euo pipefail

          location="${LOCATION}"

          if [ -z "$location" ]; then
            location="${AZURE_LOCATION_VAR}"
          fi

          if [ -z "$location" ] && [ -n "${RESOURCE_GROUP}" ]; then
            echo "ðŸ” Repository variable AZURE_LOCATION ãŒæœªè¨­å®šã®ãŸã‚ã€ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ— ${RESOURCE_GROUP} ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚"
            az account set --subscription "${AZURE_SUBSCRIPTION_ID}"
            location=$(az group show --name "${RESOURCE_GROUP}" --query location -o tsv 2>/dev/null || true)
          fi

          if [ -z "$location" ]; then
            echo "::error::ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚GitHub Variables ã§ AZURE_LOCATION ã‚’è¨­å®šã™ã‚‹ã‹ã€æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

          echo "âœ… ã‚¤ãƒ³ãƒ•ãƒ©ã‚’å±•é–‹ã™ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: $location"
          echo "LOCATION=$location" >> "$GITHUB_ENV"

      - name: Ensure Required RBAC Permissions for Deployment
        id: check_deployment_permissions
        shell: bash
        run: |
          echo "Checking Service Principal permissions for infrastructure deployment..."

          SP_OBJECT_ID=$(az ad sp list --filter "appId eq '$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientId)'" --query '[0].id' -o tsv)
          echo "SP_OBJECT_ID=$SP_OBJECT_ID" >> $GITHUB_OUTPUT

          # Required roles for infrastructure deployment
          REQUIRED_ROLES=("Contributor" "Resource Policy Contributor" "User Access Administrator")
          MISSING_ROLES=()

          for ROLE in "${REQUIRED_ROLES[@]}"; do
            ROLE_ASSIGNED=$(az role assignment list \
              --assignee-object-id "$SP_OBJECT_ID" \
              --role "$ROLE" \
              --scope "/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}" \
              --query '[].roleDefinitionName' -o tsv)
            
            if [ -z "$ROLE_ASSIGNED" ]; then
              echo "::warning::Missing role: $ROLE"
              MISSING_ROLES+=("$ROLE")
            else
              echo "âœ… Role assigned: $ROLE"
            fi
          done

          # Attempt to assign missing roles
          if [ ${#MISSING_ROLES[@]} -gt 0 ]; then
            echo "::warning::Attempting to assign missing roles..."
            
            for ROLE in "${MISSING_ROLES[@]}"; do
              echo "Assigning role: $ROLE..."
              
              if az role assignment create \
                --assignee-object-id "$SP_OBJECT_ID" \
                --assignee-principal-type ServicePrincipal \
                --role "$ROLE" \
                --scope "/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}" 2>/dev/null; then
                echo "âœ… Successfully assigned: $ROLE"
              else
                echo "::error::Failed to assign role: $ROLE"
                echo "::error::Run this command locally:"
                echo "::error::  az role assignment create \\"
                echo "::error::    --assignee-object-id $SP_OBJECT_ID \\"
                echo "::error::    --assignee-principal-type ServicePrincipal \\"
                echo "::error::    --role \"$ROLE\" \\"
                echo "::error::    --scope '/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}'"
              fi
            done
            
            # Wait for RBAC propagation
            echo "Waiting 30 seconds for RBAC changes to propagate..."
            sleep 30
          fi

      - name: Resolve Existing Mongo Role Assignments
        id: resolve_roles
        env:
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail

          RG="$RESOURCE_GROUP"
          SUBSCRIPTION_ID="$SUBSCRIPTION_ID"

          environment=$(jq -r '.parameters.environment.value // "dev"' infra/parameters/main-dev.parameters.json)
          vm_name="vm-mongo-${environment}"

          vm_identity=$(az vm show \
            --resource-group "$RG" \
            --name "$vm_name" \
            --query identity.principalId \
            -o tsv 2>/dev/null || echo '')

          storage_name=$(az storage account list \
            --resource-group "$RG" \
            --query '[0].name' \
            -o tsv 2>/dev/null || echo '')

          storage_assignment=""
          vm_contributor_assignment=""

          if [[ -n "$vm_identity" ]]; then
            if [[ -n "$storage_name" ]]; then
              storage_scope=$(az storage account show \
                --name "$storage_name" \
                --resource-group "$RG" \
                --query id \
                -o tsv)

              storage_assignment=$(az role assignment list \
                --assignee-object-id "$vm_identity" \
                --role "Storage Blob Data Contributor" \
                --scope "$storage_scope" \
                --query '[0].name' \
                -o tsv 2>/dev/null || echo '')
            fi

            rg_scope="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}"
            vm_contributor_assignment=$(az role assignment list \
              --assignee-object-id "$vm_identity" \
              --role "Virtual Machine Contributor" \
              --scope "$rg_scope" \
              --query '[0].name' \
              -o tsv 2>/dev/null || echo '')
          fi

          echo "EXISTING_STORAGE_ROLE_ASSIGNMENT=$storage_assignment" >> "$GITHUB_ENV"
          echo "EXISTING_VM_ROLE_ASSIGNMENT=$vm_contributor_assignment" >> "$GITHUB_ENV"

      - name: Preview Changes with What-If
        shell: bash
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1
          SUCCESS=false

          while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$SUCCESS" = "false" ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Running What-If analysis..."
            
            if az deployment sub what-if \
              --name infra-whatif-${{ github.run_number }}-${{ env.LOCATION }} \
              --location ${{ env.LOCATION }} \
              --template-file ./infra/main.bicep \
              --parameters \
                @infra/parameters/main-dev.parameters.json \
                resourceGroupName=${{ env.RESOURCE_GROUP }} \
                location=${{ env.LOCATION }} \
                mongoAdminPassword=${{ secrets.MONGO_ADMIN_PASSWORD }} \
                automationPrincipalObjectId=${{ vars.AZURE_GITHUB_PRINCIPAL_ID }} \
                grantAutomationPrincipalOwner=${{ env.GRANT_OWNER_PARAMETER }} \
                existingStorageRoleAssignmentName=${{ env.EXISTING_STORAGE_ROLE_ASSIGNMENT }} \
                existingVmContributorRoleAssignmentName=${{ env.EXISTING_VM_ROLE_ASSIGNMENT }} \
              --result-format ResourceIdOnly; then
              echo "âœ… What-If analysis completed successfully"
              SUCCESS=true
            else
              EXIT_CODE=$?
              echo "âš ï¸ What-If analysis failed with exit code: $EXIT_CODE"
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "RBAC permissions may still be propagating. Waiting 30 seconds before retry..."
                sleep 30
                ATTEMPT=$((ATTEMPT + 1))
              else
                echo "::error::What-If analysis failed after $MAX_ATTEMPTS attempts"
                echo "::error::Ensure Service Principal has required permissions:"
                echo "::error::  - Contributor"
                echo "::error::  - Resource Policy Contributor"
                echo "::error::  - User Access Administrator"
                exit 1
              fi
            fi
          done

      - name: Deploy Bicep
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
          scope: subscription
          region: ${{ env.LOCATION }}
          template: ./infra/main.bicep
          parameters: >
            @infra/parameters/main-dev.parameters.json
            resourceGroupName=${{ env.RESOURCE_GROUP }}
            location=${{ env.LOCATION }}
            mongoAdminPassword=${{ secrets.MONGO_ADMIN_PASSWORD }}
            automationPrincipalObjectId=${{ vars.AZURE_GITHUB_PRINCIPAL_ID }}
            grantAutomationPrincipalOwner=${{ env.GRANT_OWNER_PARAMETER }}
            existingStorageRoleAssignmentName=${{ env.EXISTING_STORAGE_ROLE_ASSIGNMENT }}
            existingVmContributorRoleAssignmentName=${{ env.EXISTING_VM_ROLE_ASSIGNMENT }}
          deploymentName: infra-deployment-${{ env.LOCATION }}-${{ github.run_number }}
          failOnStdErr: false

      - name: Get Deployment Outputs
        id: outputs
        run: |
          DEPLOYMENT_NAME="infra-deployment-${{ env.LOCATION }}-${{ github.run_number }}"

          AKS_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.aksClusterName.value \
            -o tsv)

          MONGO_IP=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.mongoVMPrivateIP.value \
            -o tsv)

          VM_IDENTITY=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.mongoVMIdentityPrincipalId.value \
            -o tsv)

          STORAGE_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.storageAccountName.value \
            -o tsv)

          ACR_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.acrName.value \
            -o tsv)

          KUBELET_IDENTITY=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.kubeletIdentityPrincipalId.value \
            -o tsv)

          WORKBOOK_ID=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.securityWorkbookId.value \
            -o tsv)

          WORKSPACE_ID=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.logAnalyticsWorkspaceId.value \
            -o tsv)

          echo "aks_name=$AKS_NAME" >> $GITHUB_OUTPUT
          echo "mongo_ip=$MONGO_IP" >> $GITHUB_OUTPUT
          echo "mongo_vm_identity=$VM_IDENTITY" >> $GITHUB_OUTPUT
          echo "storage_name=$STORAGE_NAME" >> $GITHUB_OUTPUT
          echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "kubelet_identity=$KUBELET_IDENTITY" >> $GITHUB_OUTPUT
          echo "workbook_id=$WORKBOOK_ID" >> $GITHUB_OUTPUT
          echo "workspace_id=$WORKSPACE_ID" >> $GITHUB_OUTPUT

      - name: Save Outputs as Artifacts
        run: |
          mkdir -p outputs
          echo "AKS_CLUSTER_NAME=${{ steps.outputs.outputs.aks_name }}" > outputs/infra-outputs.txt
          echo "MONGO_VM_IP=${{ steps.outputs.outputs.mongo_ip }}" >> outputs/infra-outputs.txt
          echo "ACR_NAME=${{ steps.outputs.outputs.acr_name }}" >> outputs/infra-outputs.txt
          echo "MONGO_VM_IDENTITY=${{ steps.outputs.outputs.mongo_vm_identity }}" >> outputs/infra-outputs.txt
          echo "KUBELET_IDENTITY=${{ steps.outputs.outputs.kubelet_identity }}" >> outputs/infra-outputs.txt
          echo "STORAGE_ACCOUNT_NAME=${{ steps.outputs.outputs.storage_name }}" >> outputs/infra-outputs.txt
          echo "WORKBOOK_ID=${{ steps.outputs.outputs.workbook_id }}" >> outputs/infra-outputs.txt
          echo "LOG_ANALYTICS_WORKSPACE_ID=${{ steps.outputs.outputs.workspace_id }}" >> outputs/infra-outputs.txt

          # Generate Workbook URL for easy access
          WORKBOOK_ID_ONLY=$(echo "${{ steps.outputs.outputs.workbook_id }}" | sed 's|.*/||')
          WORKSPACE_RG="${{ env.RESOURCE_GROUP }}"
          WORKBOOK_URL="https://portal.azure.com/#@/resource/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${WORKSPACE_RG}/providers/Microsoft.Insights/workbooks/${WORKBOOK_ID_ONLY}/overview"

          echo "WORKBOOK_URL=${WORKBOOK_URL}" >> outputs/infra-outputs.txt
          echo "" >> outputs/infra-outputs.txt
          echo "ðŸ”— Security Dashboard: ${WORKBOOK_URL}" >> outputs/infra-outputs.txt

      - name: Upload Outputs
        uses: actions/upload-artifact@v5
        with:
          name: infra-outputs
          path: outputs/infra-outputs.txt

      - name: Display Security Dashboard Link
        run: |
          WORKBOOK_ID_ONLY=$(echo "${{ steps.outputs.outputs.workbook_id }}" | sed 's|.*/||')
          WORKSPACE_RG="${{ env.RESOURCE_GROUP }}"
          WORKBOOK_URL="https://portal.azure.com/#@/resource/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${WORKSPACE_RG}/providers/Microsoft.Insights/workbooks/${WORKBOOK_ID_ONLY}/overview"

          echo "## ðŸŽ¯ Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Security Monitoring Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ç›£æŸ»ãƒ­ã‚°ã¨Defenderã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç¢ºèªã§ãã¾ã™:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **[Security Dashboard ã«ã‚¢ã‚¯ã‚»ã‚¹](${WORKBOOK_URL})**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒªã‚½ãƒ¼ã‚¹ | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| AKS Cluster | \`${{ steps.outputs.outputs.aks_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| MongoDB VM IP | \`${{ steps.outputs.outputs.mongo_ip }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ACR Name | \`${{ steps.outputs.outputs.acr_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | \`${{ steps.outputs.outputs.storage_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Log Analytics Workspace | \`${{ steps.outputs.outputs.workspace_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… éŽåŽ»24æ™‚é–“ã®ç›£æŸ»ãƒ­ã‚° (Administrative & Security)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… éŽåŽ»7æ—¥é–“ã® Defender ã‚¢ãƒ©ãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Azure Policy ã‚¤ãƒ™ãƒ³ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŽ¨å¥¨äº‹é … (é‡è¦åº¦åˆ¥)" >> $GITHUB_STEP_SUMMARY
