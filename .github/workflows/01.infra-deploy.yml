name: 1. Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - "infra/**"
      - ".github/workflows/01.infra-deploy.yml"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_LOCATION_VAR: ${{ vars.AZURE_LOCATION }}
  LOCATION: ${{ vars.AZURE_LOCATION }}
  GRANT_OWNER_PARAMETER: ${{ vars.AZURE_GRANT_GITHUB_OWNER || 'false' }}

jobs:
  scan-iac:
    name: Scan IaC for Security Issues
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Checkov Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infra/
          framework: bicep
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true
        continue-on-error: true # ‚úÖ Áµ±‰∏Ä: „Çπ„Ç≠„É£„É≥Â§±Êïó„Åß„ÇÇ„Ç∏„Éß„ÉñÁ∂öË°å

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: checkov-results.sarif

      - name: Run Trivy Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          format: sarif
          output: trivy-config.sarif
          input: infra
          severity: CRITICAL,HIGH
          exit-code: 0
        continue-on-error: true # ‚úÖ Áµ±‰∏Ä: „Çπ„Ç≠„É£„É≥Â§±Êïó„Åß„ÇÇ„Ç∏„Éß„ÉñÁ∂öË°å

      - name: Upload Trivy Config Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: trivy-config.sarif

      - name: Summarize IaC Scan Findings
        if: always()
        run: |
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');
          const zlib = require('zlib');

          const summaryFile = process.env.GITHUB_STEP_SUMMARY;

          const append = (line = '') => {
            fs.appendFileSync(summaryFile, `${line}\n`);
          };

          append('### IaC „Çπ„Ç≠„É£„É≥ÁµêÊûú');

          const reports = [
            { title: 'Checkov (Bicep)', file: 'checkov-results.sarif' },
            { title: 'Trivy Config (Bicep)', file: 'trivy-config.sarif' },
          ];

          const resolveSarifPath = (basePath) => {
            if (!basePath) return null;

            const existsAndFile = (target) => fs.existsSync(target) && fs.statSync(target).isFile();
            const existsAndDir = (target) => fs.existsSync(target) && fs.statSync(target).isDirectory();

            if (existsAndFile(basePath)) {
              return basePath;
            }

            const gzCandidate = `${basePath}.gz`;
            if (existsAndFile(gzCandidate)) {
              return gzCandidate;
            }

            if (existsAndDir(basePath)) {
              const entries = fs.readdirSync(basePath)
                .filter((name) => name.endsWith('.sarif') || name.endsWith('.sarif.gz'))
                .sort();
              if (entries.length > 0) {
                return path.join(basePath, entries[0]);
              }
            }

            return null;
          };

          const loadSarif = (filePath) => {
            if (!filePath) {
              return null;
            }

            const sarifPath = resolveSarifPath(filePath);
            if (!sarifPath) {
              return null;
            }

            if (sarifPath.endsWith('.gz')) {
              const buffer = zlib.gunzipSync(fs.readFileSync(sarifPath));
              return JSON.parse(buffer.toString('utf-8'));
            }

            if (!fs.statSync(sarifPath).isFile()) {
              return null;
            }

            return JSON.parse(fs.readFileSync(sarifPath, 'utf-8'));
          };

          let anyReport = false;

          for (const report of reports) {
            const baseCandidate = path.join(process.cwd(), report.file);
            const sarif = loadSarif(baseCandidate);

            append(`#### ${report.title}`);

            if (!sarif) {
              append('ÁµêÊûú„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇË©≤ÂΩì„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
              append();
              continue;
            }

            anyReport = true;
            const results = sarif?.runs?.[0]?.results ?? [];
            const errorResults = results.filter((item) => (item?.level || 'none').toLowerCase() === 'error');

            append(`Level=error „ÅÆÊ§úÂá∫Êï∞: **${errorResults.length}**`);

            if (errorResults.length === 0) {
              append('Level=error „ÅÆÊ§úÂá∫„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
              append();
              continue;
            }

            const severityCounts = {};
            const errorDetails = [];

            for (const item of errorResults) {
              const severityRaw = item?.properties?.severity || item?.properties?.securitySeverity || 'UNKNOWN';
              const severityKey = String(severityRaw).toUpperCase();
              severityCounts[severityKey] = (severityCounts[severityKey] || 0) + 1;

              const ruleId = item?.ruleId || 'Unknown rule';
              const message = item?.message?.text || item?.message || 'Ë©≥Á¥∞„É°„ÉÉ„Çª„Éº„Ç∏ÁÑ°„Åó';
              const location = item?.locations?.[0]?.physicalLocation?.artifactLocation?.uri || '';
              const trimmedLocation = location ? ` (${location})` : '';
              errorDetails.push(`- **${severityKey}** ${ruleId}: ${message}${trimmedLocation}`);
            }

            append('| Severity (Level=error) | Count |');
            append('| --- | --- |');
            for (const [key, value] of Object.entries(severityCounts)) {
              append(`| ${key} | ${value} |`);
            }

            append();
            append('„Ç®„É©„ÉºË©≥Á¥∞ (ÊúÄÂ§ß10‰ª∂):');
            const maxItems = 10;
            errorDetails.slice(0, maxItems).forEach((entry) => append(entry));
            if (errorDetails.length > maxItems) {
              append(`...‰ªñ ${errorDetails.length - maxItems} ‰ª∂„ÅÆ error „Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`);
            }

            append();
          }

          if (!anyReport) {
            append('„ÅÑ„Åö„Çå„ÅÆ SARIF ÁµêÊûú„ÇÇÁ¢∫Ë™ç„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Çπ„Ç≠„É£„É≥„Çπ„ÉÜ„ÉÉ„Éó„ÅåÊ≠£Â∏∏ÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            append();
          } else {
            append('Ë©≥Á¥∞„ÅØ Security „Çø„Éñ„ÅÆ IaC „Çπ„Ç≠„É£„É≥ÁµêÊûú„ÇíÂèÇÁÖß„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            append();
          }
          EOF

  deploy-infra:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    needs: scan-iac
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login (bootstrap RBAC)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve Deployment Location (bootstrap context)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        shell: bash
        run: |
          set -euo pipefail

          location="${AZURE_LOCATION_VAR}"

          if [ -z "$location" ] && [ -n "${RESOURCE_GROUP}" ]; then
            echo "üîç Repository variable AZURE_LOCATION „ÅåÊú™Ë®≠ÂÆö„ÅÆ„Åü„ÇÅ„ÄÅ„É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó ${RESOURCE_GROUP} „ÅÆ„É™„Éº„Ç∏„Éß„É≥„ÇíÂèñÂæó„Åó„Åæ„Åô„ÄÇ"
            az account set --subscription "${AZURE_SUBSCRIPTION_ID}"
            location=$(az group show --name "${RESOURCE_GROUP}" --query location -o tsv 2>/dev/null || true)
          fi

          if [ -z "$location" ]; then
            echo "::error::„Éá„Éó„É≠„Ç§ÂÖà„É™„Éº„Ç∏„Éß„É≥„ÇíÁâπÂÆö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇGitHub Variables „Åß AZURE_LOCATION „ÇíË®≠ÂÆö„Åô„Çã„Åã„ÄÅÊó¢Â≠ò„É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó„ÅÆ„É™„Éº„Ç∏„Éß„É≥„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            exit 1
          fi

          echo "‚úÖ „Ç§„É≥„Éï„É©„ÇíÂ±ïÈñã„Åô„Çã„É™„Éº„Ç∏„Éß„É≥: $location"
          echo "LOCATION=$location" >> "$GITHUB_ENV"

      - name: Ensure Resource Group Exists (bootstrap phase)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        env:
          SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          LOCATION: ${{ env.LOCATION }}
        run: |
          set -euo pipefail

          az account set --subscription "$SUBSCRIPTION_ID"

          if az group exists --name "$RESOURCE_GROUP" | grep -iq true; then
            echo "Resource group '$RESOURCE_GROUP' already exists."
          else
            echo "Creating resource group '$RESOURCE_GROUP' in '$LOCATION'."
            az group create --name "$RESOURCE_GROUP" --location "$LOCATION"
          fi

      - name: Ensure RBAC for GitHub Actions Principal
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        env:
          PRINCIPAL_ID: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID }}
          SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          GRANT_OWNER: ${{ vars.AZURE_GRANT_GITHUB_OWNER || 'false' }}
        run: |
          set -euo pipefail

          az account set --subscription "$SUBSCRIPTION_ID"

          ensure_assignment() {
            local scope="$1"
            local roleName="$2"

            local existing
            existing=$(az role assignment list --assignee-object-id "$PRINCIPAL_ID" --role "$roleName" --scope "$scope" --query "[].id" -o tsv)

            if [[ -n "$existing" ]]; then
              echo "Role '$roleName' already present at scope '$scope'."
            else
              echo "Assigning role '$roleName' at scope '$scope'."
              az role assignment create \
                --assignee-object-id "$PRINCIPAL_ID" \
                --assignee-principal-type ServicePrincipal \
                --role "$roleName" \
                --scope "$scope"
            fi
          }

          RG_SCOPE="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}"

          ensure_assignment "$RG_SCOPE" "User Access Administrator"

          OWNER_SCOPE="/subscriptions/${SUBSCRIPTION_ID}"
          OWNER_ASSIGNMENTS=$(az role assignment list --assignee-object-id "$PRINCIPAL_ID" --role "Owner" --scope "$OWNER_SCOPE" --query "[].id" -o tsv)

          OWNER_PARAMETER="false"

          if [ "$GRANT_OWNER" = "true" ]; then
            if [[ -n "$OWNER_ASSIGNMENTS" ]]; then
              echo "Owner role already present; Bicep module will be skipped."
            else
              echo "Owner role not detected; Bicep module will assign." # avoid double assignment errors later
              OWNER_PARAMETER="true"
            fi
          else
            if [[ -n "$OWNER_ASSIGNMENTS" ]]; then
              echo "Owner role already assigned but automation flag is false; leaving as-is."
            fi
          fi

          echo "GRANT_OWNER_PARAMETER=$OWNER_PARAMETER" >> "$GITHUB_ENV"

      - name: Azure Logout (bootstrap context)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        run: az account clear

      - name: Azure Login (Service Principal)
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve Deployment Location
        shell: bash
        run: |
          set -euo pipefail

          location="${LOCATION}"

          if [ -z "$location" ]; then
            location="${AZURE_LOCATION_VAR}"
          fi

          if [ -z "$location" ] && [ -n "${RESOURCE_GROUP}" ]; then
            echo "üîç Repository variable AZURE_LOCATION „ÅåÊú™Ë®≠ÂÆö„ÅÆ„Åü„ÇÅ„ÄÅ„É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó ${RESOURCE_GROUP} „ÅÆ„É™„Éº„Ç∏„Éß„É≥„ÇíÂèñÂæó„Åó„Åæ„Åô„ÄÇ"
            az account set --subscription "${AZURE_SUBSCRIPTION_ID}"
            location=$(az group show --name "${RESOURCE_GROUP}" --query location -o tsv 2>/dev/null || true)
          fi

          if [ -z "$location" ]; then
            echo "::error::„Éá„Éó„É≠„Ç§ÂÖà„É™„Éº„Ç∏„Éß„É≥„ÇíÁâπÂÆö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇGitHub Variables „Åß AZURE_LOCATION „ÇíË®≠ÂÆö„Åô„Çã„Åã„ÄÅÊó¢Â≠ò„É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó„ÅÆ„É™„Éº„Ç∏„Éß„É≥„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            exit 1
          fi

          echo "‚úÖ „Ç§„É≥„Éï„É©„ÇíÂ±ïÈñã„Åô„Çã„É™„Éº„Ç∏„Éß„É≥: $location"
          echo "LOCATION=$location" >> "$GITHUB_ENV"

      - name: Ensure Required RBAC Permissions for Deployment
        id: check_deployment_permissions
        shell: bash
        run: |
          echo "Checking Service Principal permissions for infrastructure deployment..."

          SP_OBJECT_ID=$(az ad sp list --filter "appId eq '$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientId)'" --query '[0].id' -o tsv)
          echo "SP_OBJECT_ID=$SP_OBJECT_ID" >> $GITHUB_OUTPUT

          # Required roles for infrastructure deployment
          REQUIRED_ROLES=("Contributor" "Resource Policy Contributor" "User Access Administrator")
          MISSING_ROLES=()

          for ROLE in "${REQUIRED_ROLES[@]}"; do
            ROLE_ASSIGNED=$(az role assignment list \
              --assignee-object-id "$SP_OBJECT_ID" \
              --role "$ROLE" \
              --scope "/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}" \
              --query '[].roleDefinitionName' -o tsv)
            
            if [ -z "$ROLE_ASSIGNED" ]; then
              echo "::warning::Missing role: $ROLE"
              MISSING_ROLES+=("$ROLE")
            else
              echo "‚úÖ Role assigned: $ROLE"
            fi
          done

          # Attempt to assign missing roles
          if [ ${#MISSING_ROLES[@]} -gt 0 ]; then
            echo "::warning::Attempting to assign missing roles..."
            
            for ROLE in "${MISSING_ROLES[@]}"; do
              echo "Assigning role: $ROLE..."
              
              if az role assignment create \
                --assignee-object-id "$SP_OBJECT_ID" \
                --assignee-principal-type ServicePrincipal \
                --role "$ROLE" \
                --scope "/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}" 2>/dev/null; then
                echo "‚úÖ Successfully assigned: $ROLE"
              else
                echo "::error::Failed to assign role: $ROLE"
                echo "::error::Run this command locally:"
                echo "::error::  az role assignment create \\"
                echo "::error::    --assignee-object-id $SP_OBJECT_ID \\"
                echo "::error::    --assignee-principal-type ServicePrincipal \\"
                echo "::error::    --role \"$ROLE\" \\"
                echo "::error::    --scope '/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}'"
              fi
            done
            
            # Wait for RBAC propagation
            echo "Waiting 30 seconds for RBAC changes to propagate..."
            sleep 30
          fi

      - name: Resolve Existing Mongo Role Assignments
        id: resolve_roles
        env:
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail

          RG="$RESOURCE_GROUP"
          SUBSCRIPTION_ID="$SUBSCRIPTION_ID"

          environment=$(jq -r '.parameters.environment.value // "dev"' infra/parameters/main-dev.parameters.json)
          vm_name="vm-mongo-${environment}"

          vm_identity=$(az vm show \
            --resource-group "$RG" \
            --name "$vm_name" \
            --query identity.principalId \
            -o tsv 2>/dev/null || echo '')

          storage_name=$(az storage account list \
            --resource-group "$RG" \
            --query '[0].name' \
            -o tsv 2>/dev/null || echo '')

          storage_assignment=""
          vm_contributor_assignment=""

          if [[ -n "$vm_identity" ]]; then
            if [[ -n "$storage_name" ]]; then
              storage_scope=$(az storage account show \
                --name "$storage_name" \
                --resource-group "$RG" \
                --query id \
                -o tsv)

              storage_assignment=$(az role assignment list \
                --assignee-object-id "$vm_identity" \
                --role "Storage Blob Data Contributor" \
                --scope "$storage_scope" \
                --query '[0].name' \
                -o tsv 2>/dev/null || echo '')
            fi

            rg_scope="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}"
            vm_contributor_assignment=$(az role assignment list \
              --assignee-object-id "$vm_identity" \
              --role "Virtual Machine Contributor" \
              --scope "$rg_scope" \
              --query '[0].name' \
              -o tsv 2>/dev/null || echo '')
          fi

          echo "EXISTING_STORAGE_ROLE_ASSIGNMENT=$storage_assignment" >> "$GITHUB_ENV"
          echo "EXISTING_VM_ROLE_ASSIGNMENT=$vm_contributor_assignment" >> "$GITHUB_ENV"

      - name: Preview Changes with What-If
        shell: bash
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1
          SUCCESS=false

          while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$SUCCESS" = "false" ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Running What-If analysis..."
            
            if az deployment sub what-if \
              --name infra-whatif-${{ github.run_number }}-${{ env.LOCATION }} \
              --location ${{ env.LOCATION }} \
              --template-file ./infra/main.bicep \
              --parameters \
                @infra/parameters/main-dev.parameters.json \
                resourceGroupName=${{ env.RESOURCE_GROUP }} \
                location=${{ env.LOCATION }} \
                mongoAdminPassword=${{ secrets.MONGO_ADMIN_PASSWORD }} \
                automationPrincipalObjectId=${{ vars.AZURE_GITHUB_PRINCIPAL_ID }} \
                grantAutomationPrincipalOwner=${{ env.GRANT_OWNER_PARAMETER }} \
                existingStorageRoleAssignmentName=${{ env.EXISTING_STORAGE_ROLE_ASSIGNMENT }} \
                existingVmContributorRoleAssignmentName=${{ env.EXISTING_VM_ROLE_ASSIGNMENT }} \
                enableDefenderContinuousExport=true \
              --result-format ResourceIdOnly; then
              echo "‚úÖ What-If analysis completed successfully"
              SUCCESS=true
            else
              EXIT_CODE=$?
              echo "‚ö†Ô∏è What-If analysis failed with exit code: $EXIT_CODE"
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "RBAC permissions may still be propagating. Waiting 30 seconds before retry..."
                sleep 30
                ATTEMPT=$((ATTEMPT + 1))
              else
                echo "::error::What-If analysis failed after $MAX_ATTEMPTS attempts"
                echo "::error::Ensure Service Principal has required permissions:"
                echo "::error::  - Contributor"
                echo "::error::  - Resource Policy Contributor"
                echo "::error::  - User Access Administrator"
                exit 1
              fi
            fi
          done

      - name: Deploy Bicep
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
          scope: subscription
          region: ${{ env.LOCATION }}
          template: ./infra/main.bicep
          parameters: >
            @infra/parameters/main-dev.parameters.json
            resourceGroupName=${{ env.RESOURCE_GROUP }}
            location=${{ env.LOCATION }}
            mongoAdminPassword=${{ secrets.MONGO_ADMIN_PASSWORD }}
            automationPrincipalObjectId=${{ vars.AZURE_GITHUB_PRINCIPAL_ID }}
            grantAutomationPrincipalOwner=${{ env.GRANT_OWNER_PARAMETER }}
            existingStorageRoleAssignmentName=${{ env.EXISTING_STORAGE_ROLE_ASSIGNMENT }}
            existingVmContributorRoleAssignmentName=${{ env.EXISTING_VM_ROLE_ASSIGNMENT }}
            enableDefenderContinuousExport=true
          deploymentName: infra-deployment-${{ env.LOCATION }}-${{ github.run_number }}
          failOnStdErr: false

      - name: Get Deployment Outputs
        id: outputs
        run: |
          DEPLOYMENT_NAME="infra-deployment-${{ env.LOCATION }}-${{ github.run_number }}"

          AKS_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.aksClusterName.value \
            -o tsv)

          MONGO_IP=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.mongoVMPrivateIP.value \
            -o tsv)

          VM_IDENTITY=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.mongoVMIdentityPrincipalId.value \
            -o tsv)

          STORAGE_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.storageAccountName.value \
            -o tsv)

          ACR_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.acrName.value \
            -o tsv)

          KUBELET_IDENTITY=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.kubeletIdentityPrincipalId.value \
            -o tsv)

          WORKBOOK_ID=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.securityWorkbookId.value \
            -o tsv)

          WORKSPACE_ID=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.logAnalyticsWorkspaceId.value \
            -o tsv)

          echo "aks_name=$AKS_NAME" >> $GITHUB_OUTPUT
          echo "mongo_ip=$MONGO_IP" >> $GITHUB_OUTPUT
          echo "mongo_vm_identity=$VM_IDENTITY" >> $GITHUB_OUTPUT
          echo "storage_name=$STORAGE_NAME" >> $GITHUB_OUTPUT
          echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "kubelet_identity=$KUBELET_IDENTITY" >> $GITHUB_OUTPUT
          echo "workbook_id=$WORKBOOK_ID" >> $GITHUB_OUTPUT
          echo "workspace_id=$WORKSPACE_ID" >> $GITHUB_OUTPUT

      - name: Save Outputs as Artifacts
        run: |
          mkdir -p outputs
          echo "AKS_CLUSTER_NAME=${{ steps.outputs.outputs.aks_name }}" > outputs/infra-outputs.txt
          echo "MONGO_VM_IP=${{ steps.outputs.outputs.mongo_ip }}" >> outputs/infra-outputs.txt
          echo "ACR_NAME=${{ steps.outputs.outputs.acr_name }}" >> outputs/infra-outputs.txt
          echo "MONGO_VM_IDENTITY=${{ steps.outputs.outputs.mongo_vm_identity }}" >> outputs/infra-outputs.txt
          echo "KUBELET_IDENTITY=${{ steps.outputs.outputs.kubelet_identity }}" >> outputs/infra-outputs.txt
          echo "STORAGE_ACCOUNT_NAME=${{ steps.outputs.outputs.storage_name }}" >> outputs/infra-outputs.txt
          echo "WORKBOOK_ID=${{ steps.outputs.outputs.workbook_id }}" >> outputs/infra-outputs.txt
          echo "LOG_ANALYTICS_WORKSPACE_ID=${{ steps.outputs.outputs.workspace_id }}" >> outputs/infra-outputs.txt

          # Generate Workbook URL for easy access
          WORKBOOK_ID_ONLY=$(echo "${{ steps.outputs.outputs.workbook_id }}" | sed 's|.*/||')
          WORKSPACE_RG="${{ env.RESOURCE_GROUP }}"
          WORKBOOK_URL="https://portal.azure.com/#@/resource/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${WORKSPACE_RG}/providers/Microsoft.Insights/workbooks/${WORKBOOK_ID_ONLY}/overview"

          echo "WORKBOOK_URL=${WORKBOOK_URL}" >> outputs/infra-outputs.txt
          echo "" >> outputs/infra-outputs.txt
          echo "üîó Security Dashboard: ${WORKBOOK_URL}" >> outputs/infra-outputs.txt

      - name: Upload Outputs
        uses: actions/upload-artifact@v5
        with:
          name: infra-outputs
          path: outputs/infra-outputs.txt

      - name: Display Security Dashboard Link
        run: |
          WORKBOOK_ID_ONLY=$(echo "${{ steps.outputs.outputs.workbook_id }}" | sed 's|.*/||')
          WORKSPACE_RG="${{ env.RESOURCE_GROUP }}"
          WORKBOOK_URL="https://portal.azure.com/#@/resource/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${WORKSPACE_RG}/providers/Microsoft.Insights/workbooks/${WORKBOOK_ID_ONLY}/overview"

          echo "## üéØ Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Security Monitoring Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Åå„Éá„Éó„É≠„Ç§„Åï„Çå„Åæ„Åó„Åü„ÄÇ‰ª•‰∏ã„ÅÆ„É™„É≥„ÇØ„Åã„ÇâÁõ£Êüª„É≠„Ç∞„Å®Defender„Ç¢„É©„Éº„Éà„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **[Security Dashboard „Å´„Ç¢„ÇØ„Çª„Çπ](${WORKBOOK_URL})**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ „Éá„Éó„É≠„Ç§„Åï„Çå„Åü„É™„ÇΩ„Éº„Çπ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| „É™„ÇΩ„Éº„Çπ | ÂÄ§ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| AKS Cluster | \`${{ steps.outputs.outputs.aks_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| MongoDB VM IP | \`${{ steps.outputs.outputs.mongo_ip }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ACR Name | \`${{ steps.outputs.outputs.acr_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | \`${{ steps.outputs.outputs.storage_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Log Analytics Workspace | \`${{ steps.outputs.outputs.workspace_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊ©üËÉΩ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ ÈÅéÂéª24ÊôÇÈñì„ÅÆÁõ£Êüª„É≠„Ç∞ (Administrative & Security)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ ÈÅéÂéª7Êó•Èñì„ÅÆ Defender „Ç¢„É©„Éº„Éà" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Azure Policy „Ç§„Éô„É≥„Éà" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Çø„Ç§„É†„É©„Ç§„É≥" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ „Çª„Ç≠„É•„É™„ÉÜ„Ç£Êé®Â•®‰∫ãÈ†Ö (ÈáçË¶ÅÂ∫¶Âà•)" >> $GITHUB_STEP_SUMMARY
